<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>消息队列 - Wishlily's blog</title><meta name=Description content="消息队列"><meta property="og:url" content="https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/">
<meta property="og:site_name" content="Wishlily's blog"><meta property="og:title" content="消息队列"><meta property="og:description" content="消息队列"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2016-08-31T17:01:19+00:00"><meta property="article:modified_time" content="2016-08-31T17:01:19+00:00"><meta property="article:tag" content="Ipc"><meta property="article:tag" content="Sysv"><meta property="og:image" content="https://wishlily.github.io/favicon.png"><meta property="og:see_also" content="https://wishlily.github.io/article/2016/09/05/ipc-shm/"><meta property="og:see_also" content="https://wishlily.github.io/article/2016/09/01/linux-ipc-semaphore/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wishlily.github.io/favicon.png"><meta name=twitter:title content="消息队列"><meta name=twitter:description content="消息队列"><meta name=application-name content="Wishlily's blog"><meta name=apple-mobile-web-app-title content="Wishlily's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/><link rel=prev href=https://wishlily.github.io/article/2016/07/28/hexo/><link rel=next href=https://wishlily.github.io/article/2016/09/01/linux-ipc-semaphore/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"消息队列","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/wishlily.github.io\/article\/2016\/08\/31\/linux-ipc-sysv-message-queue\/"},"genre":"posts","keywords":"ipc, sysv","wordcount":2011,"url":"https:\/\/wishlily.github.io\/article\/2016\/08\/31\/linux-ipc-sysv-message-queue\/","datePublished":"2016-08-31T17:01:19+00:00","dateModified":"2016-08-31T17:01:19+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Wishlily"},"description":"消息队列"}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Wishlily's blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.ico data-srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x" data-sizes=auto alt=/favicon.ico title=/favicon.ico>Wishlily's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/series/>系列 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Wishlily's blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.ico data-srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x" data-sizes=auto alt=/favicon.ico title=/favicon.ico>Wishlily's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/series/ title>系列</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">消息队列</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Wishlily</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/system/><i class="far fa-folder fa-fw" aria-hidden=true></i>系统</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2016-08-31>2016-08-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 2011 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 5 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/images/banner/ipc-in-linux.jpg data-srcset="/images/banner/ipc-in-linux.jpg, /images/banner/ipc-in-linux.jpg 1.5x, /images/banner/ipc-in-linux.jpg 2x" data-sizes=auto alt=/images/banner/ipc-in-linux.jpg title=消息队列 width=867 height=403></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#流程>流程</a></li><li><a href=#函数>函数</a><ul><li><a href=#ftok>ftok</a></li><li><a href=#msgget>msgget</a></li><li><a href=#msgctl>msgctl</a></li><li><a href=#msgsndmsgrcv>msgsnd/msgrcv</a></li></ul></li><li><a href=#实例>实例</a><ul><li><a href=#server>server</a></li><li><a href=#client>client</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>为了提供与其他系统的兼容性，Linux 也支持 3 种 system V 的进程间通信机制：消息、信号量（semaphores）和共享内存，Linux 对这些机制的实施大同小异。我们把信号量、消息和共享内存统称 System V IPC 的对象，每一个对象都具有同样类型的接口，即系统调用。就像每个文件都有一个打开文件号一样，每个对象也都有唯一的识别号，进程可以通过系统调用传递的识别号来存取这些对象，与文件的存取一样，对这些对象的存取也要验证存取权限，System V IPC 可以通过系统调用对对象的创建者设置这些对象的存取权限。<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><br>一个或多个进程可向消息队列写入消息，而一个或多个进程可从消息队列中读取消息，这种进程间通信机制通常使用在<strong>客户</strong>/<strong>服务器</strong>模型中，客户向服务器发送请求消息，服务器读取消息并执行相应请求。在许多微内核结构的操作系统中，内核和各组件之间的基本通信方式就是消息队列。<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p><strong>注</strong>：<br><em>IPC: Inter-Process Communication（进程间通信）</em></p><h2 id=流程>流程</h2><p>一般流程<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>如下：</p><ol><li>通过 <code>ftok</code> 获得确定的 IPC Key</li><li>使用 <code>msgget</code> 获得用于消息队列的特定 IPC ID</li><li>使用 <code>msgsnd/msgrcv</code> 收发消息</li><li>使用 <code>msgctl</code> 移除队列</li></ol><h2 id=函数>函数</h2><p>常用函数<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>如下：</p><h3 id=ftok>ftok</h3><p>将路径文件名（存在且可访问）和一个 8bit 标识符转换成 System V IPC 键值。</p><pre><code>#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;

key_t ftok(const char *pathname, int proj_id)
</code></pre><ul><li>pathname：文件名，必须存在</li><li>proj_id：仅 8bit 有效，不可为零</li><li>return：-1，发生错误，可通过 <code>errno</code> 查看；其他返回表示得到的键值</li></ul><p><strong>注</strong>：<br><em>只要 <code>pathname</code> 和 <code>proj_id</code> 一致则返回的键值就一直，因此两个进程可以通过此函数获得同一个键值。</em></p><h3 id=msgget>msgget</h3><p>建立一个消息队列。</p><pre><code>#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/msg.h&gt;

int msgget(key_t key, int msgflg)
</code></pre><ul><li>key：<code>ftok</code> 中返回的键值</li><li>msgflg：使用 <code>|</code> 连接<ul><li>权限：可使用 <code>0666</code> 等表示，也可使用 <code>open</code> 中 <code>mode</code> 宏</li><li>IPC_CREAT：若不存在则创建</li><li>IPC_EXCL：若存在则返回错误（和 <code>IPC_CREAT</code> 一起使用）</li></ul></li><li>return：-1，发生错误，可通过 <code>errno</code> 查看；非负数，消息队列 ID</li></ul><p><strong>注</strong>：<br><em>系统中的消息队列可通过 <code>ipcs -q</code> 查看。</em></p><h3 id=msgctl>msgctl</h3><p>对消息队列的控制，查询、设置、删除。</p><pre><code>#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/msg.h&gt;

int msgctl(int msqid, int cmd, struct msqid_ds *buf)
</code></pre><ul><li>msqid：<code>msgget</code> 得到 ID</li><li>cmd：常用如下<ul><li>IPC_STAT：从内核获得消息队列的信息到 <code>buf</code> 中</li><li>IPC_SET：通过 <code>buf</code> 修改内核中该消息的一些信息</li><li>IPC_RMID：从内核移除该消息</li></ul></li><li>buf：消息队列的相关信息</li><li>return：-1，发生错误，可通过 <code>errno</code> 查看</li></ul><p><strong>注</strong>：<br><em>系统中已存在的消息也可通过 <code>ipcrm -q/Q</code> 来删除。</em></p><h3 id=msgsndmsgrcv>msgsnd/msgrcv</h3><p>发送/接收消息到队列。</p><pre><code>#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/msg.h&gt;

int msgsnd(int msqid, const void *msgp, size_t msgsz, int msgflg)

ssize_t msgrcv(int msqid, void *msgp, size_t msgsz, long msgtyp, int msgflg)
</code></pre><ul><li><p>msqid：<code>msgget</code> 得到 ID</p></li><li><p>msgp：形式如下</p><pre><code>  struct msgbuf {
  	long mtype;       /* message type, must be &gt; 0 */
  	char mtext[1];    /* message data */
  };
</code></pre><p><code>mtype</code> 必须包含，<code>data</code> 部分可以是自定义的数据结构（总长度不能超过 8192 字节）<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>。</p></li><li><p>msgsz：消息长度</p></li><li><p>msgflg：</p><ul><li>0：忽略</li><li>IPC_NOWAIT：消息队列满则返回程序继续执行，否则阻塞</li><li>0：忽略</li><li>IPC_NOWAIT：如果消息队列为空则程序继续执行，否则阻塞</li><li>MSG_EXCEPT：<code>msgtyp > 0</code> 时作用，取不等于</li><li>MSG_NOERROR：如果消息大于 <code>msgsz</code> 自动截断丢弃，否则不会被取出</li></ul></li><li><p>msgtyp：</p><ul><li>等于 0：取出队列中最早的消息</li><li>大于 0：取出消息中最早 <code>mtype</code> 等于此值的消息</li><li>小于 0：取出消息中最早 <code>mtype</code> 小于等于此值绝对值的消息</li></ul></li><li><p>return：-1，发生错误，可通过 <code>errno</code> 查看</p></li></ul><h2 id=实例>实例</h2><p>服务器/客户端例子<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup></p><h3 id=server>server</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;unistd.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/msg.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;signal.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define MSG_FILE &#34;server.c&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define BUFFER 255
</span></span></span><span class=line><span class=cl><span class=cp>#define PERM S_IRUSR|S_IWUSR
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=n>msgid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>clean_exit</span><span class=p>(</span><span class=kt>int</span> <span class=n>sig</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 从内核中移除消息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>msgctl</span><span class=p>(</span><span class=n>msgid</span><span class=p>,</span> <span class=n>IPC_RMID</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Remove Message Error：%s</span><span class=se>\a\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=n>sig</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>msgtype</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>mtype</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=n>BUFFER</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>signal</span><span class=p>(</span><span class=n>SIGINT</span><span class=p>,</span> <span class=n>clean_exit</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>msgtype</span> <span class=n>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>key_t</span> <span class=n>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 获得消息键
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>((</span><span class=n>key</span><span class=o>=</span><span class=nf>ftok</span><span class=p>(</span><span class=n>MSG_FILE</span><span class=p>,</span><span class=sc>&#39;a&#39;</span><span class=p>))</span><span class=o>==-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Creat Key Error：%s</span><span class=se>\a\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 创建消息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span><span class=p>((</span><span class=n>msgid</span><span class=o>=</span><span class=nf>msgget</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=n>PERM</span><span class=o>|</span><span class=n>IPC_CREAT</span><span class=o>|</span><span class=n>IPC_EXCL</span><span class=p>))</span><span class=o>==-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Creat Message Error：%s</span><span class=se>\a\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>msgrcv</span><span class=p>(</span><span class=n>msgid</span><span class=p>,</span><span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>msgtype</span><span class=p>),</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Server Receive：%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>msg</span><span class=p>.</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>msg</span><span class=p>.</span><span class=n>mtype</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>msgsnd</span><span class=p>(</span><span class=n>msgid</span><span class=p>,</span><span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>msgtype</span><span class=p>),</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=client>client</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/types.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/ipc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/msg.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;sys/stat.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define MSG_FILE &#34;../server/server.c&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#define BUFFER 255
</span></span></span><span class=line><span class=cl><span class=cp>#define PERM S_IRUSR|S_IWUSR
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>msgtype</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>mtype</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span><span class=p>[</span><span class=n>BUFFER</span><span class=o>+</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span><span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>msgtype</span> <span class=n>msg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>key_t</span> <span class=n>key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>msgid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=n>argc</span><span class=o>!=</span><span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Usage：%s string</span><span class=se>\n\a</span><span class=s>&#34;</span><span class=p>,</span><span class=n>argv</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>key</span><span class=o>=</span><span class=nf>ftok</span><span class=p>(</span><span class=n>MSG_FILE</span><span class=p>,</span><span class=sc>&#39;a&#39;</span><span class=p>))</span><span class=o>==-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Creat Key Error：%s</span><span class=se>\a\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>((</span><span class=n>msgid</span><span class=o>=</span><span class=nf>msgget</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=n>PERM</span><span class=p>))</span><span class=o>==-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Creat Message Error：%s</span><span class=se>\a\n</span><span class=s>&#34;</span><span class=p>,</span><span class=nf>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>msg</span><span class=p>.</span><span class=n>mtype</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>strncpy</span><span class=p>(</span><span class=n>msg</span><span class=p>.</span><span class=n>buffer</span><span class=p>,</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>BUFFER</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>msgsnd</span><span class=p>(</span><span class=n>msgid</span><span class=p>,</span><span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>msgtype</span><span class=p>),</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span><span class=sc>&#39;\0&#39;</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>msgtype</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>msgrcv</span><span class=p>(</span><span class=n>msgid</span><span class=p>,</span><span class=o>&amp;</span><span class=n>msg</span><span class=p>,</span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>msgtype</span><span class=p>),</span><span class=mi>2</span><span class=p>,</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&#34;Client receive：%s</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=n>msg</span><span class=p>.</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>深入分析Linux内核源代码,7.3&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>深入分析Linux内核源代码,7.3.2&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://www.ibm.com/developerworks/cn/aix/library/au-ipc/ target=_blank rel="noopener noreffer">使用 UNIX System V IPC 机制共享应用程序数据</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>linux man 手册&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>深入分析Linux内核源代码,7.3.2,P284&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p><a href=http://lobert.iteye.com/blog/1743256 target=_blank rel="noopener noreffer">linux c学习笔记&mdash;-消息队列（ftok,msgget，msgsnd，msgrcv，msgctl）</a>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2016-08-31</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/ data-hashtag=ipc><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/ data-title=消息队列><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/ data-title=消息队列><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://wishlily.github.io/article/2016/08/31/linux-ipc-sysv-message-queue/ data-title=消息队列 data-image=/images/banner/ipc-in-linux.jpg><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/ipc/>Ipc</a>,&nbsp;<a href=/tags/sysv/>Sysv</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/article/2016/07/28/hexo/ class=prev rel=prev title="Hexo Blog"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Hexo Blog</a>
<a href=/article/2016/09/01/linux-ipc-semaphore/ class=next rel=next title=信号量>信号量<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.145.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2015 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Wishlily</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Q&A",categoryId:"DIC_kwDODuSf184Ct4tE",darkTheme:"dark",emitMetadata:"0",inputPosition:"top",lang:"zh-CN",lazyLoading:!0,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"wishlily/wishlily.github.io",repoId:"MDEwOlJlcG9zaXRvcnkyNDk4NjQxNTE="}},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-R4ZHVCJLGY",{anonymize_ip:!0})</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-R4ZHVCJLGY" async></script></body></html>