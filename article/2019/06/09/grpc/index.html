<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>grpc - Wishlily's blog</title><meta name=Description content="技术学习分享"><meta property="og:url" content="https://wishlily.github.io/article/2019/06/09/grpc/">
<meta property="og:site_name" content="Wishlily's blog"><meta property="og:title" content="grpc"><meta property="og:description" content="最近使用了一下 grpc 通信，现在整理一下，防止遗忘。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-09T14:01:02+00:00"><meta property="article:modified_time" content="2019-06-09T14:01:02+00:00"><meta property="article:tag" content="Grpc"><meta property="article:tag" content="Go"><meta property="article:tag" content="Java"><meta property="og:image" content="https://wishlily.github.io/article/2019/06/09/grpc/image.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://wishlily.github.io/article/2019/06/09/grpc/image.png"><meta name=twitter:title content="grpc"><meta name=twitter:description content="最近使用了一下 grpc 通信，现在整理一下，防止遗忘。"><meta name=application-name content="Wishlily's blog"><meta name=apple-mobile-web-app-title content="Wishlily's blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel=icon href=/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://wishlily.github.io/article/2019/06/09/grpc/><link rel=prev href=https://wishlily.github.io/article/2018/09/29/react-component-communication/><link rel=next href=https://wishlily.github.io/article/2019/06/13/vscode/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><meta name=google-site-verification content="G-R4ZHVCJLGY"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"grpc","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/wishlily.github.io\/article\/2019\/06\/09\/grpc\/"},"image":[{"@type":"ImageObject","url":"https:\/\/wishlily.github.io\/article\/2019\/06\/09\/grpc\/image.png","width":1586,"height":621}],"genre":"posts","keywords":"grpc, go, java","wordcount":1945,"url":"https:\/\/wishlily.github.io\/article\/2019\/06\/09\/grpc\/","datePublished":"2019-06-09T14:01:02+00:00","dateModified":"2019-06-09T14:01:02+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Wishlily"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Wishlily's blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.ico data-srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x" data-sizes=auto alt=/favicon.ico title=/favicon.ico>Wishlily's blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/series/>系列 </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Wishlily's blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/favicon.ico data-srcset="/favicon.ico, /favicon.ico 1.5x, /favicon.ico 2x" data-sizes=auto alt=/favicon.ico title=/favicon.ico>Wishlily's blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/series/ title>系列</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">grpc</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Wishlily</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/network/><i class="far fa-folder fa-fw" aria-hidden=true></i>网络</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-06-09>2019-06-09</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 1945 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 4 分钟&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/article/2019/06/09/grpc/image.png data-srcset="/article/2019/06/09/grpc/image.png, /article/2019/06/09/grpc/image.png 1.5x, /article/2019/06/09/grpc/image.png 2x" data-sizes=auto alt=/article/2019/06/09/grpc/image.png title=/article/2019/06/09/grpc/image.png></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#安装>安装</a><ul><li><a href=#protoc>protoc</a></li><li><a href=#protoc-gen-go>protoc-gen-go</a></li><li><a href=#protoc-gen-grpc-java>protoc-gen-grpc-java</a></li></ul></li><li><a href=#proto>proto</a></li><li><a href=#go>go</a><ul><li><a href=#server>server</a></li><li><a href=#client>client</a></li><li><a href=#demo>demo</a></li></ul></li><li><a href=#java>java</a><ul><li><a href=#server-1>server</a></li><li><a href=#client-1>client</a></li><li><a href=#demo-1>demo</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>最近使用了一下 grpc 通信，现在整理一下，防止遗忘。</p><h2 id=安装>安装</h2><p>grpc 可以支持不同的语言，详细可查看 <a href=https://github.com/grpc/ target=_blank rel="noopener noreffer">github</a>。<br>这次我主要使用的是 go 和 java，<br>golang 因为墙的关系有几个包需要找镜像下载<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>git clone https://github.com/grpc/grpc-go.git <span class=nv>$GOPATH</span>/src/google.golang.org/grpc
</span></span><span class=line><span class=cl>git clone https://github.com/golang/net.git <span class=nv>$GOPATH</span>/src/golang.org/x/net
</span></span><span class=line><span class=cl>git clone https://github.com/golang/text.git <span class=nv>$GOPATH</span>/src/golang.org/x/text
</span></span><span class=line><span class=cl>git clone https://github.com/golang/sys.git <span class=nv>$GOPATH</span>/src/golang.org/x/sys
</span></span><span class=line><span class=cl>go get -u github.com/golang/protobuf/<span class=o>{</span>proto,protoc-gen-go<span class=o>}</span>
</span></span><span class=line><span class=cl>git clone https://github.com/google/go-genproto.git <span class=nv>$GOPATH</span>/src/google.golang.org/genproto
</span></span><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$GOPATH</span>/src/
</span></span><span class=line><span class=cl>go install google.golang.org/grpc
</span></span></code></pre></div><p>我看官方也详细写了使用 <code>go mod</code> 的安装方法。</p><h3 id=protoc>protoc</h3><p>这是一个通过 <code>proto</code> 文件，自动生成不同语言代码的工具。<br>github 上可以直接下载 release，地址：<a href=https://github.com/protocolbuffers/protobuf/releases target=_blank rel="noopener noreffer">https://github.com/protocolbuffers/protobuf/releases</a>。<br>比较省事的就是下载编译好的程序，比如我系统是 linux 64，就下载 <code>protoc-x.x.x-linux-x86_64.zip</code>，直接解压放到 <code>PATH</code> 下就行，<code>protoc --veriosn</code> 查看版本。</p><h3 id=protoc-gen-go>protoc-gen-go</h3><p>配合 <code>protoc</code> goalng 使用的插件</p><pre><code>go get -u github.com/golang/protobuf/{proto,protoc-gen-go}
</code></pre><blockquote><p>使用时注意 <code>protoc-gen-go</code> 必须在系统 <code>PATH</code> 中<br><code>export PATH=$PATH:$GOPATH/bin</code></p></blockquote><p>运行以下命令可以自动生成 go 文件</p><pre><code>protoc --go_out=plugins=grpc:. *.proto
</code></pre><h3 id=protoc-gen-grpc-java>protoc-gen-grpc-java</h3><p>官方提供的 java 插件，安装下载地址 <a href=https://github.com/grpc/grpc-java/tree/master/compiler target=_blank rel="noopener noreffer">https://github.com/grpc/grpc-java/tree/master/compiler</a></p><blockquote><p>貌似系统 java 1.7 无法编译，应该需要更高的版本，或者下载已经编译好的工具，如 <a href=https://repo1.maven.org/maven2/io/grpc/protoc-gen-grpc-java/1.19.0/ target=_blank rel="noopener noreffer">1.19</a></p></blockquote><p>运行以下命令自动生成 java 文件</p><pre><code>protoc --java_out=. *.proto
protoc --plugin=protoc-gen-grpc-java=/xxx/xxx/protoc-gen-grpc-java --grpc-java_out=. *.proto
</code></pre><blockquote><p>路径根据实际情况修改，java 至少需要 2 个文件</p></blockquote><h2 id=proto>proto</h2><p>官方都有给简易例子，以下添加一些说明：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-proto data-lang=proto><span class=line><span class=cl><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>option</span> <span class=n>java_multiple_files</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>              <span class=c1>// java 文件是否生成多个文件，我直接选择否方便 git 操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>java_package</span> <span class=o>=</span> <span class=s>&#34;com.wishlily.helloworld&#34;</span><span class=p>;</span> <span class=c1>// java 路径
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>option</span> <span class=n>java_outer_classname</span> <span class=o>=</span> <span class=s>&#34;HelloWorldProto&#34;</span><span class=p>;</span> <span class=c1>// java 类名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>grpc</span><span class=p>;</span>                                    <span class=c1>// golang 包名
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// 通信接口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>service</span> <span class=n>Greeter</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=k>rpc</span> <span class=n>SayHello</span><span class=p>(</span><span class=n>Hello</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Null</span><span class=p>)</span> <span class=p>{}</span>       <span class=c1>// 客户端给服务器信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>rpc</span> <span class=n>SayBye</span><span class=p>(</span><span class=n>Null</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>Bye</span><span class=p>)</span> <span class=p>{}</span>    <span class=c1>// 可用作服务器回调信息
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Null</span> <span class=p>{}</span>             <span class=c1>// 即便传输为空也需要一个构造，或者引入官方包中的 google.protobuf.Empty
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Hello</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>msg</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>int64</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>Bye</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kd>enum</span> <span class=n>Number</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>ONE</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>        <span class=n>TWO</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=n>Number</span> <span class=n>num</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>    <span class=kt>string</span> <span class=n>msg</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></div><h2 id=go>go</h2><p>根据官方例子修改如下：</p><h3 id=server>server</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span> <span class=s>&#34;sayhi/grpc&#34;</span>          <span class=c1>// protoc-gen-go 生成文件包</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>server</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>hi</span> <span class=kt>bool</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>number</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>name</span>   <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>msg</span>    <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 客户端 -&gt; 服务器</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Hello</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Null</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>reply</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Null</span><span class=p>{}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>number</span> <span class=p>=</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetNum</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>name</span> <span class=p>=</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetName</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>msg</span> <span class=p>=</span> <span class=nx>in</span><span class=p>.</span><span class=nf>GetMsg</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%d: %s Say %s\n&#34;</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>number</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>name</span><span class=p>,</span> <span class=nx>s</span><span class=p>.</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>.</span><span class=nx>hi</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>reply</span><span class=p>,</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 服务器 -&gt; 客户端</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>SayBye</span><span class=p>(</span><span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Null</span><span class=p>,</span> <span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Greeter_SayByeServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span> <span class=c1>// 此处不退出，会一直在该线路上发送，哪怕连接已断，一定要判断 Send 结果</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>hi</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>bye</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Bye</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>Msg</span><span class=p>:</span> <span class=s>&#34;Receive: &#34;</span> <span class=o>+</span> <span class=nx>s</span><span class=p>.</span><span class=nx>msg</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>number</span> <span class=o>%</span> <span class=mi>2</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>bye</span><span class=p>.</span><span class=nx>Num</span> <span class=p>=</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Bye_ONE</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>bye</span><span class=p>.</span><span class=nx>Num</span> <span class=p>=</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>Bye_TWO</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=nx>bye</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span> <span class=c1>// 服务器主动发起消息</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=nx>err</span> <span class=c1>// Disconnect</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>s</span><span class=p>.</span><span class=nx>hi</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Millisecond</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>Listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=s>&#34;localhost:10086&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterGreeterServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=nb>new</span><span class=p>(</span><span class=nx>server</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Server start ...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>开始接触 grpc 时一直想不明白，服务器怎么主动发起消息，后来明白其实就使用 stream，单方向就一直保持这个 stream 不关闭就行，当然这个连接还是要 client 先发起才行。</p><h3 id=client>client</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>wait</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>int</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;localhost:10086&#34;</span><span class=p>,</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>c</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewGreeterClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>name</span> <span class=o>:=</span> <span class=s>&#34;Robyn&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>name</span> <span class=p>=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>msg</span> <span class=o>:=</span> <span class=s>&#34;Hello&#34;</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>msg</span> <span class=p>=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>num</span> <span class=o>:=</span> <span class=nb>int64</span><span class=p>(</span><span class=mi>120</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=p>&gt;</span> <span class=mi>3</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>n</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>strconv</span><span class=p>.</span><span class=nf>Atoi</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=nx>num</span> <span class=p>=</span> <span class=nb>int64</span><span class=p>(</span><span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayHello</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Hello</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>Msg</span><span class=p>:</span> <span class=nx>msg</span><span class=p>,</span> <span class=nx>Num</span><span class=p>:</span> <span class=nx>num</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;%d: %s Say %s\n&#34;</span><span class=p>,</span> <span class=nx>num</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>stream</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SayBye</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Null</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>bye</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>break</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Say Bye %v %v\n&#34;</span><span class=p>,</span> <span class=nx>bye</span><span class=p>.</span><span class=nf>GetNum</span><span class=p>(),</span> <span class=nx>bye</span><span class=p>.</span><span class=nf>GetMsg</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>wait</span> <span class=o>&lt;-</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=o>&lt;-</span><span class=nx>wait</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=demo>demo</h3><p>测试结果如下：</p><p>client</p><pre tabindex=0><code>[root@localhost client]## go run main.go
Say Bye ONE:Receive: Hello
120: Robyn Say Hello
[root@localhost client]## go run main.go Emily Hi 23
Say Bye TWO Receive: Hi
23: Emily Say Hi
</code></pre><p>server</p><pre tabindex=0><code>[root@localhost server]## go run main.go
Server start ...
120: Robyn Say Hello
23: Emily Say Hi
</code></pre><h2 id=java>java</h2><p>首先介绍打包方式：一种是使用 maven，另一种是使用 ant。</p><p>maven 这部分根据官方<a href=https://github.com/grpc/grpc-java/blob/master/examples/pom.xml target=_blank rel="noopener noreffer">例子</a>摘抄</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;properties&gt;</span>
</span></span><span class=line><span class=cl>	...
</span></span><span class=line><span class=cl>	<span class=nt>&lt;grpc.version&gt;</span>1.19.0<span class=nt>&lt;/grpc.version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/properties&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependencyManagement&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;groupId&gt;</span>io.grpc<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;artifactId&gt;</span>grpc-bom<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;version&gt;</span>${grpc.version}<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;type&gt;</span>pom<span class=nt>&lt;/type&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;scope&gt;</span>import<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/dependencies&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependencyManagement&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependencies&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;groupId&gt;</span>io.grpc<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;artifactId&gt;</span>grpc-netty-shaded<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;scope&gt;</span>runtime<span class=nt>&lt;/scope&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;groupId&gt;</span>io.grpc<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;artifactId&gt;</span>grpc-protobuf<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;groupId&gt;</span>io.grpc<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;artifactId&gt;</span>grpc-stub<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p>ant 就需要提前下载好 jar 包，将这些一起打包到你的包里：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;target</span> <span class=na>name=</span><span class=s>&#34;client&#34;</span> <span class=na>depends=</span><span class=s>&#34;compile&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;mkdir</span> <span class=na>dir=</span><span class=s>&#34;${prepjar}&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;copy</span> <span class=na>todir=</span><span class=s>&#34;${prepjar}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;fileset</span> <span class=na>dir=</span><span class=s>&#34;${classes}&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/copy&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;jar</span> <span class=na>jarfile=</span><span class=s>&#34;${clientjarfilename}&#34;</span> <span class=na>basedir=</span><span class=s>&#34;${prepjar}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;manifest&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;attribute</span> <span class=na>name=</span><span class=s>&#34;Main-Class&#34;</span> <span class=na>value=</span><span class=s>&#34;com.xxx.MainClass&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;/manifest&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;exclude</span> <span class=na>name=</span><span class=s>&#34;**/xxx/**&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;zipgroupfileset</span> <span class=na>dir=</span><span class=s>&#34;${grpc}&#34;</span> <span class=na>includes=</span><span class=s>&#34;**/*.jar&#34;</span> <span class=nt>/&gt;</span> <span class=c>&lt;!-- 主要这句拷贝路径下所有 jar --&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/jar&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;delete</span> <span class=na>dir=</span><span class=s>&#34;${prepjar}&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/target&gt;</span>
</span></span></code></pre></div><h3 id=server-1>server</h3><p>服务器首先使用 <code>protoc</code> 工具生成两个文件：<code>GreeterGrpc.java</code> & <code>HelloWorldProto.java</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Server</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>io</span><span class=p>.</span><span class=na>grpc</span><span class=p>.</span><span class=na>Server</span><span class=w> </span><span class=n>server</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>10086</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ServerBuilder</span><span class=p>.</span><span class=na>forPort</span><span class=p>(</span><span class=n>port</span><span class=p>).</span><span class=na>addService</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>GreeterImpl</span><span class=p>()).</span><span class=na>build</span><span class=p>().</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;Server started, listening on 10086&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>addShutdownHook</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// Use stderr here since the logger may have been reset by its JVM shutdown</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// hook.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;*** shutting down gRPC server since JVM is shutting down&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Server</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>System</span><span class=p>.</span><span class=na>err</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;*** server shut down&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>stop</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>server</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>server</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>blockUntilShutdown</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>server</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>server</span><span class=p>.</span><span class=na>awaitTermination</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>GreeterImpl</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>GreeterImplBase</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>sayHi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=n>Bye</span><span class=w> </span><span class=n>bye</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sayHello</span><span class=p>(</span><span class=n>Hello</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>StreamObserver</span><span class=o>&lt;</span><span class=n>Null</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseObserver</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Null</span><span class=w> </span><span class=n>reply</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Null</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>().</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Number</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Number</span><span class=p>.</span><span class=na>ONE</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>req</span><span class=p>.</span><span class=na>getNum</span><span class=p>()</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Number</span><span class=p>.</span><span class=na>TWO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getName</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getMsg</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=s>&#34;%d: %s Say %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>req</span><span class=p>.</span><span class=na>getNum</span><span class=p>(),</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>bye</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bye</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>().</span><span class=na>setNum</span><span class=p>(</span><span class=n>num</span><span class=p>).</span><span class=na>setMsg</span><span class=p>(</span><span class=s>&#34;Get: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>msg</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>responseObserver</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>reply</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>responseObserver</span><span class=p>.</span><span class=na>onCompleted</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>sayHi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sayBye</span><span class=p>(</span><span class=n>Null</span><span class=w> </span><span class=n>req</span><span class=p>,</span><span class=w> </span><span class=n>StreamObserver</span><span class=o>&lt;</span><span class=n>Bye</span><span class=o>&gt;</span><span class=w> </span><span class=n>responseObserver</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sayHi</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>sayHi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=s>&#34;%s Bye %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>bye</span><span class=p>.</span><span class=na>getNum</span><span class=p>(),</span><span class=w> </span><span class=n>bye</span><span class=p>.</span><span class=na>getMsg</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>responseObserver</span><span class=p>.</span><span class=na>onNext</span><span class=p>(</span><span class=n>bye</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>StatusRuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// 是 grpc 出现错误时抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>responseObserver</span><span class=p>.</span><span class=na>onError</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w>     </span><span class=c1>// 测试中如果没有 onError | onCompleted，则下一次连接会出现问题</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=n>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=n>Server</span><span class=w> </span><span class=n>server</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Server</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>server</span><span class=p>.</span><span class=na>blockUntilShutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=client-1>client</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Client</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ManagedChannel</span><span class=w> </span><span class=n>channel</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>GreeterGrpc</span><span class=p>.</span><span class=na>GreeterBlockingStub</span><span class=w> </span><span class=n>blockingStub</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ByeListenThread</span><span class=w> </span><span class=n>byeListenThread</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/** Construct client for accessing RouteGuide server at {@code host:port}. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Client</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>port</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>this</span><span class=p>(</span><span class=n>ManagedChannelBuilder</span><span class=p>.</span><span class=na>forAddress</span><span class=p>(</span><span class=n>host</span><span class=p>,</span><span class=w> </span><span class=n>port</span><span class=p>).</span><span class=na>usePlaintext</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * Construct client for accessing RouteGuide server using the existing channel.
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>Client</span><span class=p>(</span><span class=n>ManagedChannelBuilder</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>channelBuilder</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>channelBuilder</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>blockingStub</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GreeterGrpc</span><span class=p>.</span><span class=na>newBlockingStub</span><span class=p>(</span><span class=n>channel</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>byeListenThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ByeListenThread</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>byeListenThread</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=s>&#34;Client_ByeListenThread&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>byeListenThread</span><span class=p>.</span><span class=na>setDaemon</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>byeListenThread</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>shutdown</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>channel</span><span class=p>.</span><span class=na>shutdown</span><span class=p>().</span><span class=na>awaitTermination</span><span class=p>(</span><span class=n>5</span><span class=p>,</span><span class=w> </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>SECONDS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>byeListenThread</span><span class=p>.</span><span class=na>cancel</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sayHello</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HelloWorldProto</span><span class=p>.</span><span class=na>Hello</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HelloWorldProto</span><span class=p>.</span><span class=na>Hello</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>().</span><span class=na>setName</span><span class=p>(</span><span class=n>name</span><span class=p>).</span><span class=na>setMsg</span><span class=p>(</span><span class=n>msg</span><span class=p>).</span><span class=na>setNum</span><span class=p>(</span><span class=n>num</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>blockingStub</span><span class=p>.</span><span class=na>sayHello</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=s>&#34;%d: %s Say %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>num</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>ByeListenThread</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isAlive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>HelloWorldProto</span><span class=p>.</span><span class=na>Null</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>HelloWorldProto</span><span class=p>.</span><span class=na>Null</span><span class=p>.</span><span class=na>newBuilder</span><span class=p>().</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>HelloWorldProto</span><span class=p>.</span><span class=na>Bye</span><span class=o>&gt;</span><span class=w> </span><span class=n>bye</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>isAlive</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>bye</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>blockingStub</span><span class=p>.</span><span class=na>sayBye</span><span class=p>(</span><span class=n>request</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>bye</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// block</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>HelloWorldProto</span><span class=p>.</span><span class=na>Bye</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bye</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// if data have ptr part, hasXXX check</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>printf</span><span class=p>(</span><span class=s>&#34;Bye %s: %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>getNum</span><span class=p>(),</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>getMsg</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>isAlive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>super</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancel</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>isAlive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>InterruptedException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Client</span><span class=w> </span><span class=n>c</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Client</span><span class=p>(</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=n>10086</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;Java&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;hello&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>2046</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>num</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Integer</span><span class=p>.</span><span class=na>parseInt</span><span class=p>(</span><span class=n>args</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=p>.</span><span class=na>sayHello</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=n>num</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// wait</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;wait ...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>InputStreamReader</span><span class=w> </span><span class=n>is_reader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>in</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BufferedReader</span><span class=p>(</span><span class=n>is_reader</span><span class=p>).</span><span class=na>readLine</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>c</span><span class=p>.</span><span class=na>shutdown</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=demo-1>demo</h3><p>和 golang 一样而且可以交叉测试，不过 go client & java server 会有超时错误，没有详细查看。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://www.jianshu.com/p/a94673ad10dc target=_blank rel="noopener noreffer">golang安装gRpc</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-06-09</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://wishlily.github.io/article/2019/06/09/grpc/ data-hashtag=grpc><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://wishlily.github.io/article/2019/06/09/grpc/ data-title=grpc><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Reddit" data-sharer=reddit data-url=https://wishlily.github.io/article/2019/06/09/grpc/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://wishlily.github.io/article/2019/06/09/grpc/ data-title=grpc><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@7.3.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://wishlily.github.io/article/2019/06/09/grpc/ data-title=grpc><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/grpc/>Grpc</a>,&nbsp;<a href=/tags/go/>Go</a>,&nbsp;<a href=/tags/java/>Java</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/article/2018/09/29/react-component-communication/ class=prev rel=prev title="react 组件通信"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>react 组件通信</a>
<a href=/article/2019/06/13/vscode/ class=next rel=next title=VSCode>VSCode<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app>Giscus</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.145.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.0"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2015 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Wishlily</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=/lib/lunr/lunr.stemmer.support.min.js></script><script type=text/javascript src=/lib/lunr/lunr.zh.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:50},comment:{giscus:{category:"Q&A",categoryId:"DIC_kwDODuSf184Ct4tE",darkTheme:"dark",emitMetadata:"0",inputPosition:"top",lang:"zh-CN",lazyLoading:!0,lightTheme:"light",mapping:"pathname",reactionsEnabled:"1",repo:"wishlily/wishlily.github.io",repoId:"MDEwOlJlcG9zaXRvcnkyNDk4NjQxNTE="}},search:{highlightTag:"em",lunrIndexURL:"/index.json",lunrLanguageCode:"zh",lunrSegmentitURL:"/lib/lunr/lunr.segmentit.js",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>